name: Check Debian Cloud Image Updates

on:
  schedule:
    # Check daily at 6am UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  check-updates:
    name: Check for Debian Cloud Image Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write        # Allow pushing commits and branches
      pull-requests: write   # Allow creating pull requests
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Get current tracked version
        id: current
        run: |
          # Read current version from a tracking file
          if [ -f .debian-cloud-version ]; then
            echo "version=$(cat .debian-cloud-version)" >> $GITHUB_OUTPUT
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Get latest Debian cloud image version
        id: latest
        run: |
          # Fetch the directory listing and extract the date from the image filename
          LATEST_DATE=$(curl -sL "https://cloud.debian.org/images/cloud/trixie/daily/latest/" | \
            grep -oP 'debian-13-nocloud-amd64-daily-\K[0-9]+' | head -1 || echo "")

          if [ -z "$LATEST_DATE" ]; then
            # Fallback: use the Last-Modified header from the image
            LATEST_DATE=$(curl -sIL "https://cloud.debian.org/images/cloud/trixie/daily/latest/debian-13-nocloud-amd64-daily.qcow2" | \
              grep -i "Last-Modified" | awk '{print $3, $4, $5}' | xargs -I {} date -d "{}" +%Y%m%d 2>/dev/null || date +%Y%m%d)
          fi

          echo "version=${LATEST_DATE}" >> $GITHUB_OUTPUT
          echo "Latest Debian cloud image date: ${LATEST_DATE}"

      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.current.outputs.version }}" != "${{ steps.latest.outputs.version }}" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "Update needed: ${{ steps.current.outputs.version }} -> ${{ steps.latest.outputs.version }}"
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
            echo "No update needed, already at ${{ steps.current.outputs.version }}"
          fi

      - name: Create update branch and PR
        if: steps.check.outputs.update_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Define branch name
          BRANCH_NAME="auto-update/debian-cloud-${{ steps.latest.outputs.version }}"

          # Check if a PR already exists for this update
          EXISTING_PR=$(gh pr list --head "${BRANCH_NAME}" --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #${EXISTING_PR} already exists for this update. Skipping..."
            exit 0
          fi

          # Check if branch exists on remote and delete it
          if git ls-remote --heads origin "${BRANCH_NAME}" | grep -q "${BRANCH_NAME}"; then
            echo "Branch ${BRANCH_NAME} exists on remote. Deleting it..."
            git push origin --delete "${BRANCH_NAME}" || true
          fi

          # Create new branch
          git checkout -b "${BRANCH_NAME}"

          # Update version tracking file
          echo "${{ steps.latest.outputs.version }}" > .debian-cloud-version

          # Commit changes
          git add .debian-cloud-version
          git commit -m "chore: update Debian cloud image to ${{ steps.latest.outputs.version }}

          Automated update detected new Debian 13 cloud image version.

          This PR will trigger image rebuilds with the latest base image,
          including security updates and bug fixes from Debian.

          ðŸ¤– Generated automatically by GitHub Actions"

          # Push branch
          git push -u origin "${BRANCH_NAME}"

          # Create PR with proper body formatting using heredoc
          gh pr create \
            --title "Update Debian cloud image to ${{ steps.latest.outputs.version }}" \
            --body-file <(cat <<EOF
          ## Automated Debian Cloud Image Update

          A new Debian 13 (Trixie) cloud image has been detected.

          **Previous version:** \`${{ steps.current.outputs.version }}\`
          **New version:** \`${{ steps.latest.outputs.version }}\`

          ### What this updates:
          - Base Debian 13 cloud image with latest security patches
          - System packages and dependencies

          ### After merging:
          1. Create a new release tag to build updated images
          2. The Build Images workflow will create new qcow2 images

          ---
          ðŸ¤– This PR was created automatically by the [Check Debian Updates](${{ github.server_url }}/${{ github.repository }}/actions/workflows/check-debian-updates.yml) workflow.
          EOF
          )

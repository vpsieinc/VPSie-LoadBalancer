name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Check formatting
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Code is not properly formatted. Run 'make fmt'"
            gofmt -s -l .
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Check dependencies
        run: |
          go mod tidy
          if [ -n "$(git status --porcelain go.mod go.sum)" ]; then
            echo "go.mod or go.sum is not tidy"
            git diff go.mod go.sum
            exit 1
          fi

      - name: Run tests with race detector
        run: go test -race -v ./...

      - name: Check for TODO/FIXME comments
        run: |
          if grep -r "TODO\|FIXME" pkg/ cmd/ --exclude-dir=vendor; then
            echo "Warning: Found TODO or FIXME comments"
          fi

  size-check:
    name: Binary Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build and check size
        run: |
          go build -ldflags="-s -w" -o vpsie-lb-agent ./cmd/agent
          SIZE=$(stat -c%s vpsie-lb-agent)
          echo "Binary size: $SIZE bytes"
          if [ $SIZE -gt 50000000 ]; then
            echo "Warning: Binary size exceeds 50MB"
          fi

  image-build-validation:
    name: Validate Image Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build agent binary
        env:
          GOOS: linux
          GOARCH: amd64
        run: |
          mkdir -p build
          go build -ldflags "-s -w" -o build/vpsie-lb-agent-amd64 ./cmd/agent
          chmod +x build/vpsie-lb-agent-amd64

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: 'latest'

      - name: Initialize Packer
        run: packer init packer/

      - name: Validate Packer configuration
        run: |
          cd packer
          packer validate -var="version=0.0.0-pr" .

      - name: Build image (validation only)
        run: |
          cd packer
          packer build -only=qemu.debian-amd64 -var="version=0.0.0-pr" .
          echo "Image build completed successfully - artifacts not uploaded (PR validation only)"

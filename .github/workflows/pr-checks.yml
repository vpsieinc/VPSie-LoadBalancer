name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Check formatting
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Code is not properly formatted. Run 'make fmt'"
            gofmt -s -l .
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Check dependencies
        run: |
          go mod tidy
          if [ -n "$(git status --porcelain go.mod go.sum)" ]; then
            echo "go.mod or go.sum is not tidy"
            git diff go.mod go.sum
            exit 1
          fi

      - name: Run tests with race detector
        run: go test -race -v ./...

      - name: Check for TODO/FIXME comments
        run: |
          if grep -r "TODO\|FIXME" pkg/ cmd/ --exclude-dir=vendor; then
            echo "Warning: Found TODO or FIXME comments"
          fi

  size-check:
    name: Binary Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build and check size
        run: |
          go build -ldflags="-s -w" -o vpsie-lb-agent ./cmd/agent
          SIZE=$(stat -c%s vpsie-lb-agent)
          echo "Binary size: $SIZE bytes"
          if [ $SIZE -gt 50000000 ]; then
            echo "Warning: Binary size exceeds 50MB"
          fi

  image-build-validation:
    name: Validate Image Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate build script syntax
        run: |
          bash -n packer/scripts/build-cloud-image.sh
          echo "Build script syntax is valid"

      - name: Verify Debian cloud images are accessible
        run: |
          # Check amd64 image URL (follow redirects)
          curl -sIL "https://cloud.debian.org/images/cloud/trixie/daily/latest/debian-13-nocloud-amd64-daily.qcow2" | grep -q "200"
          echo "amd64 cloud image is accessible"

          # Check arm64 image URL (follow redirects)
          curl -sIL "https://cloud.debian.org/images/cloud/trixie/daily/latest/debian-13-nocloud-arm64-daily.qcow2" | grep -q "200"
          echo "arm64 cloud image is accessible"
